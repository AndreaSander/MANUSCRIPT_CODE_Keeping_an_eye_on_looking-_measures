---
title: "2_Analyses_and_visuals"
author: "ASM"
date: "2023-10-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r call in libraries and clean data, include=FALSE}
library(here)
library(dplyr)
library(stringr)

load(here("clean_data/arch_final.Rda"))

```


```{r clean data to be used in analyses}

kbh_data_clean <- arch_final%>%
  group_by(studio_project_name, studio_test_name, trial_number, recording_name)%>%
  mutate(trial_from_zero = recording_timestamp-min(recording_timestamp))%>%
  group_by(studio_project_name)%>%
  mutate(noun_onset = case_when(studio_project_name=="CompMix-36"~trial_from_zero-3000, #Substracting noun onset to normalize
                                studio_project_name=="LearnMix-36"~trial_from_zero-4500,
                                studio_project_name=="Mix-20"~trial_from_zero-5400,
                                studio_project_name=="Mix-14"~trial_from_zero-5400,
                                studio_project_name=="CogMisp-24"~trial_from_zero-1500))%>%
  ungroup()%>%
  rename(target_side=target, distractor_side=distractor,
         gaze_point_x= gaze_point_x_adc_spx, 
         gaze_point_y = gaze_point_y_adc_spx)%>%
  filter(gaze_point_x>=0 & gaze_point_x<= 1920)%>% #keeps only observations that are in the screen
  filter(gaze_point_y>=0 & gaze_point_y<=1200)%>%
  filter(!is.na(gaze_point_x))%>% #gets rid of the observations where tobii didn't get any reading
  filter(!is.na(gaze_point_y))%>%
  filter(!is.na(validity_left)) %>%
  filter(!is.na(validity_right)) %>%
  filter(validity_left<= 1)%>%
  filter(validity_right <= 1)%>%
  mutate(target = case_when(gaze_point_x >= target_x_min&gaze_point_x <= target_x_max&gaze_point_y >= target_y_min&gaze_point_y <= target_y_max~TRUE, 
                            TRUE~FALSE))

#Create trial language column to describe the language in which the babies were tested
kbh_data_clean <- kbh_data_clean %>%
  ungroup()%>%
  group_by(studio_test_name, eng_exp, fre_exp)%>%
  mutate(trial_lang = case_when(str_detect(studio_test_name,"E")~ "english",
                                str_detect(studio_test_name, "F")~ "french"))

```


```{r calculate all the different dependent variables}

#1. Proportion looking to target

prop_looking <- kbh_data_clean %>%
  filter(noun_onset>= 360 & noun_onset <= 3000)%>%
  group_by(recording_name, subject_id, trial_number, media_name, age_months, exp_target_lang_prop)%>%
  summarise(samples_total=sum(target==TRUE, target==FALSE ),
            samples_target=sum(target))%>%
  mutate(prop_looking= samples_target/samples_total) 

#2. Proportion looking difference

#3. Number of fixations

#4. Correct first shift to target

#5. Reaction time

distractor_initial_trials <- kbh_data_clean %>%
  filter(noun_onset >= 360 & noun_onset <= 1800)%>%
  mutate(initial_trial = case_when(
    noun_onset >=360 & noun_onset <=400 & target==FALSE ~ "distractor_initial",
    noun_onset >=360 & noun_onset <=400 & target==TRUE ~ "target_initial")
) %>%
  group_by(recording_name, subject_id, trial_number, media_name, initial_trial) %>% 
  summarise() %>%
  filter(initial_trial =="distractor_initial")

RT <- full_join (kbh_data_clean, distractor_initial_trials) %>%
  filter(initial_trial=="distractor_initial") %>%
  filter(noun_onset >= 360 & noun_onset <= 1800)%>%
mutate(first_true = ifelse(target == TRUE & lag(target) == FALSE, 1, 0)) %>%
  filter(first_true == 1) %>%

   group_by(recording_name, subject_id, trial_number, media_name,noun_onset ) %>%  
  summarise() %>%
  mutate(latency_to_switch = noun_onset - 360)

#6. Total number of switches between AOIs

#7. Mean latency of refixation during trial

#8. Mean fixation duration during trial

#9. Proportion of fixation duration

#10. Pupil dilation

#11. Duration of first look

```


